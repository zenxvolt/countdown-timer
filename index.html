<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown Timer</title>
    <meta name="theme-color" content="#1a73e8"/>
    <link rel="manifest" href="#manifest">
    <link rel="apple-touch-icon" href="/api/placeholder/192/192">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin: 1rem;
            max-width: 90vw;
        }

        .timer {
            font-size: 4rem;
            font-weight: bold;
            margin: 2rem 0;
            color: #1a73e8;
        }

        input[type="datetime-local"] {
            padding: 0.8rem;
            margin: 1rem 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1.1rem;
            max-width: 90%;
        }

        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
            margin: 0.5rem;
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            background-color: #1557b0;
        }

        .info {
            margin-top: 1rem;
            color: #666;
        }

        #installButton {
            display: none;
            background-color: #34a853;
        }

        @media (display-mode: standalone) {
            #installButton {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Countdown Timer</h1>
        <div class="timer" id="timer">00:00:00</div>
        <input type="datetime-local" id="targetDate">
        <br>
        <button onclick="startTimer()">Mulai Timer</button>
        <button onclick="resetTimer()" style="background-color: #dc3545;">Reset</button>
        <button id="installButton">Install App</button>
        <p class="info" id="info"></p>
    </div>

    <script>
        // Manifest content sebagai blob URL
        const manifestContent = {
            "name": "Countdown Timer",
            "short_name": "Timer",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f0f2f5",
            "theme_color": "#1a73e8",
            "description": "Simple countdown timer app",
            "icons": [{
                "src": "/api/placeholder/192/192",
                "sizes": "192x192",
                "type": "image/png"
            }, {
                "src": "/api/placeholder/512/512",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestContent)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').href = manifestURL;

        // Service Worker content sebagai blob URL
        const swContent = `
            const CACHE_NAME = 'countdown-timer-v1';
            const urlsToCache = [
                '/',
                '/index.html',
                'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js'
            ];

            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then((cache) => cache.addAll(urlsToCache))
                );
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request)
                        .then((response) => response || fetch(event.request))
                );
            });
        `;

        const swBlob = new Blob([swContent], {type: 'text/javascript'});
        const swURL = URL.createObjectURL(swBlob);

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swURL)
                .then(registration => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        }

        // Install PWA
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'inline-block';
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
                installButton.style.display = 'none';
            }
        });

        let countdown;
        const timerDisplay = document.getElementById('timer');
        const infoDisplay = document.getElementById('info');
        const targetInput = document.getElementById('targetDate');

        // Set minimal input datetime ke waktu sekarang
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        targetInput.min = now.toISOString().slice(0,16);

        // Cek localStorage saat halaman dimuat
        window.onload = function() {
            const savedTarget = localStorage.getItem('targetDate');
            if (savedTarget) {
                targetInput.value = savedTarget;
                startTimer();
            }
        };

        function startTimer() {
            clearInterval(countdown);

            const targetDate = new Date(targetInput.value).getTime();
            const now = new Date().getTime();

            if (targetDate <= now) {
                alert('Pilih waktu di masa depan!');
                return;
            }

            localStorage.setItem('targetDate', targetInput.value);

            countdown = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    clearInterval(countdown);
                    timerDisplay.innerHTML = "SELESAI!";
                    localStorage.removeItem('targetDate');
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Countdown Selesai!', {
                            body: 'Timer telah mencapai target waktu',
                            icon: '/api/placeholder/192/192'
                        });
                    }
                    return;
                }

                const hours = Math.floor(distance / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerDisplay.innerHTML = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                const targetMoment = moment(targetDate);
                infoDisplay.innerHTML = `Target: ${targetMoment.format('DD MMMM YYYY, HH:mm')}`;
            }, 1000);
        }

        function resetTimer() {
            clearInterval(countdown);
            localStorage.removeItem('targetDate');
            timerDisplay.innerHTML = "00:00:00";
            targetInput.value = '';
            infoDisplay.innerHTML = '';
        }

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
